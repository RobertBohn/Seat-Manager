
var SM={show:null,merchants:null,events:null,dates:null,zoom:100.0,timestamp:0,selectedDate:null,resize:function(){$('#map').css('height',($(window).height()-160)+'px');$('#map').css('width',($(window).width()-20)+'px');},ready:function(){$(window).resize(function(){SM.resize();});this.resize();$.ajaxSetup({error:function(x,e){$('#container').css('cursor','default');if(x.status==0){alert('You are offline!!\n Please Check Your Network.');}else if(x.status==404){alert('Requested URL not found.');}else if(x.status==500){alert('Internel Server Error.');}else if(e=='parsererror'){alert('Error.\nParsing JSON Request failed.');}else if(e=='timeout'){alert('Request Time out.');}else{alert('Unknow Error.\n'+x.responseText);}}});SM.timestamp=new Date().getTime();$('#zoomout').click(function(){SM.resizeShow(-12.5);});$('#zoomin').click(function(){SM.resizeShow(12.5);});$('#merchants').change(SM.merchantSelected);$('#events').change(SM.eventSelected);$('#dates').change(SM.dateSelected);$('#times').change(SM.timeSelected);$('#actions').change(SM.actionsSelected);$('#submit').click(function(){SM.submitClicked();});$('#signin').click(function(){SM.getMerchants();});$('#username').keypress(function(){if(event.keyCode=='13'){SM.getMerchants();}});$('#password').keypress(function(){if(event.keyCode=='13'){SM.getMerchants();}});$('#from').bind('focusin',function(){if(this.value=='from:')this.value='';});$('#to').bind('focusin',function(){if(this.value=='to:')this.value='';});SMconfig.ready();},resizeShow:function(increment){if(!SM.show)return;if(SM.zoom+increment>150||SM.zoom+increment<50)return;SM.zoom+=increment;$('#matt').css('width',(SM.show.map_width*SM.zoom/100)+'px');$('#matt').css('height',(SM.show.map_height*SM.zoom/100)+'px');for(i=0;i<SM.show.seats.length;i++){var seat=SM.show.seats[i];$('#s'+seat.id).css('left',(seat.x*SM.zoom/100)+'px');$('#s'+seat.id).css('top',(seat.y*SM.zoom/100)+'px');$('#s'+seat.id).css('width',(SM.show.seat_width*SM.zoom/100)+'px');$('#s'+seat.id).css('height',(SM.show.seat_height*SM.zoom/100)+'px');}},getMerchants:function(){SM.clearEvents();$.getJSON(SMconfig.json+'?type=signin&user='+$('#username').val()+'&psw='+$('#password').val(),function(data){SM.merchants=data;var m=SM.merchants.merchants;switch(m.length){case 0:alert('You are not authorized to view any merchants.');break;case 1:$('#login').hide();$('#container').show();$('#merchants').html('<option value="'+m[0].id+'">'+SM.description_1(m[0].name)+'</option>');SM.merchantSelected();break;default:$('#login').hide();$('#container').show();$('#merchants').html('<option value="0">Merchants</option>').removeAttr('disabled');for(i=0;i<m.length;i++)
$('#merchants').append('<option value="'+m[i].id+'">'+SM.description_1(m[i].name)+'</option>');break;}});},getEvents:function(){SM.clearDates();$.getJSON(SMconfig.json+'?type=events&merchant='+$('#merchants option:selected').val(),function(data){SM.events=data;var e=SM.events.events;switch(e.length){case 0:alert('There are no upcoming assigned seating events for this merchant.');break;case 1:$('#events').html('<option value="'+e[0].id+'">'+e[0].name+'</option>');SM.eventSelected();break;default:$('#events').html('<option value="0">Events</option>').removeAttr('disabled');for(i=0;i<e.length;i++)
$('#events').append('<option value="'+e[i].id+'">'+e[i].name+'</option>');break;}});},getDates:function(){SM.clearTimes();$.getJSON(SMconfig.json+'?type=dates&event='+$('#events option:selected').val(),function(data){SM.dates=data;var d=SM.dates.dates;switch(d.length){case 0:alert('There are no upcoming dates for this event.');break;case 1:$('#dates').html('<option value="'+d[0].id+'">'+d[0].name+'</option>');SM.dateSelected();break;default:$('#dates').html('<option value="0">Event Dates</option>').removeAttr('disabled');for(i=0;i<d.length;i++)
$('#dates').append('<option value="'+d[i].id+'">'+d[i].name+'</option>');if(SM.selectedDate){if($('#dates option[value="'+SM.selectedDate+'"]')){$('#dates option[value="'+SM.selectedDate+'"]').attr("selected",true);SM.dateSelected();}else{SM.selectedDate=null;}}
break;}});},getTimes:function(){SM.clearGate();var d=SM.dates.dates;var t=null;for(i=0;i<d.length;i++){if(d[i].id==$('#dates option:selected').val()){t=d[i].times;break;}}
if(!t)return;switch(t.length){case 0:alert('There are no event times for this date.');break;case 1:$('#times').html('<option value="'+t[0].id+'">'+t[0].name+'</option>');SM.timeSelected();break;default:$('#times').html('<option value="0">Event Times</option>').removeAttr('disabled');for(i=0;i<t.length;i++)
$('#times').append('<option value="'+t[i].id+'">'+t[i].name+'</option>');break;}},getShow:function(){$('#submit').attr('disabled',true);$('#container').css('cursor','wait');$.getJSON(SMconfig.json+'?type=seats&merchant='+$('#merchants option:selected').val()+'&event='+$('#events option:selected').val()+'&date='+$('#dates option:selected').val()+'&time='+$('#times option:selected').val()+'&_='+SM.timestamp++,function(data){SM.show=data;s='<li><img id="matt" src="images/'+SM.show.map_src+'" style="width:'+SM.show.map_width+'px; height:'+SM.show.height+'px;"/></li>';for(i=0;i<SM.show.seats.length;i++){var seat=SM.show.seats[i];seat.selected=false;s+='<li><img id="s'+seat.id+'" title="'+seat.id+': '+seat.d+'" src="images/'+SM.getSeatImage(i)+'" onclick="SM.seatClicked('+i+');"/></li>';}
$('#gate').html(s);SM.resizeShow(0);$('#actions').removeAttr('disabled');$('#zoomin').removeAttr('disabled');$('#zoomout').removeAttr('disabled');$('#submit').removeAttr('disabled');$('#container').css('cursor','default');});},merchantSelected:function(){$('#merchants').removeAttr('disabled');if($('#merchants option:selected').val()=='0')
SM.clearEvents();else
SM.getEvents();},eventSelected:function(){$('#events').removeAttr('disabled');if($('#events option:selected').val()=='0')
SM.clearDates();else
SM.getDates();},dateSelected:function(){$('#dates').removeAttr('disabled');if($('#dates option:selected').val()=='0'){SM.selectedDate=null;SM.clearTimes();}else{SM.selectedDate=$('#dates option:selected').val();SM.getTimes();}},timeSelected:function(){$('#times').removeAttr('disabled');SM.getShow();},actionsSelected:function(){if($('#actions option:selected').val()=='7'){$('#from').show();$('#to').show();}else{$('#from').hide();$('#to').hide();}},clearEvents:function(){$('#events').html('<option value="0">Events</option>').attr('disabled',true);SM.clearDates();},clearDates:function(){$('#dates').html('<option value="0">Event Dates</option>').attr('disabled',true);SM.clearTimes();},clearTimes:function(){$('#times').html('<option value="0">Event Times</option>').attr('disabled',true);SM.clearGate();},clearGate:function(){$('#actions').attr('disabled',true);$('#submit').attr('disabled',true);$('#zoomin').attr('disabled',true);$('#zoomout').attr('disabled',true);$('#gate').html('');},seatClicked:function(idx){var seat=SM.show.seats[idx];seat.selected=(seat.selected)?false:true;$('#s'+seat.id).attr('src','images/'+SM.getSeatImage(idx));},submitClicked:function(){switch($('#actions option:selected').val()){case'1':SM.getShow();break;case'2':case'3':SM.blockSeats(($('#actions option:selected').val()==2)?'B':'H');break;case'4':case'5':SM.releaseSeats(($('#actions option:selected').val()==4)?'B':'H');break;case'6':alert('Change Seats is not functional yet.');break;case'7':var from=parseInt($('#from').val());var to=parseInt($('#to').val());if(isNaN(from)||isNaN(to)){alert('Please enter valid \'from\' and \'to\' seat numbers.');}else{for(i=0;i<SM.show.seats.length;i++){var seat=SM.show.seats[i];if(seat.id>=from&&seat.id<=to){seat.selected=true;$('#s'+seat.id).attr('src','images/'+SM.show.selected);}}}
break;case'8':SM.animation(-1);break;}},getSeatImage:function(idx){var seat=SM.show.seats[idx];var img=SM.show.inactive;switch(seat.s){case'A':img=SM.show.available;break;case'S':img=SM.show.sold;break;case'B':img=SM.show.blocked;break;case'H':img=SM.show.held;break;}
if(seat.selected)img=SM.show.selected;return img;},blockSeats:function(type){var event_id=$('#events option:selected').val();var package_id=0;for(i=0;i<SM.events.events.length;i++){if(SM.events.events[i].id==event_id){package_id=SM.events.events[i].package_id;break;}}
var seats='';for(i=0;i<SM.show.seats.length;i++){var seat=SM.show.seats[i];if(seat.selected&&seat.s=='A'){if(seats!='')seats+='-';seats+=seat.id;}}
if(seats==''){alert('There are no available seats selected.');}else{$('#submit').attr('disabled',true);$('#container').css('cursor','wait');var post_data={'type':'block','seats':seats,'hold':type,'merchant':$('#merchants option:selected').val(),'package':package_id,'date':$('#dates option:selected').val(),'time':$('#times option:selected').val()};$.post(SMconfig.json+'?type=block&',post_data,function(data){if(data.status!='OK'){$('#container').css('cursor','default');alert(data.message);$('#submit').removeAttr('disabled');}else{SM.getShow();}},'json');}},releaseSeats:function(type){var event_id=$('#events option:selected').val();var package_id=0;for(i=0;i<SM.events.events.length;i++){if(SM.events.events[i].id==event_id){package_id=SM.events.events[i].package_id;break;}}
var seats='';for(i=0;i<SM.show.seats.length;i++){var seat=SM.show.seats[i];if(seat.selected&&seat.s==type){if(seats!='')seats+='-';seats+=seat.id;}}
if(seats==''){alert('There are no '+((type=='B')?'blocked':'held')+' seats selected.');}else{$('#submit').attr('disabled',true);$('#container').css('cursor','wait');var post_data={'type':'release','seats':seats,'hold':type,'merchant':$('#merchants option:selected').val(),'package':package_id,'date':$('#dates option:selected').val(),'time':$('#times option:selected').val()};$.post(SMconfig.json+'?type=release&',post_data,function(data){if(data.status!='OK'){$('#container').css('cursor','default');alert(data.message);$('#submit').removeAttr('disabled');}else{SM.getShow();}},'json');}},animation:function(idx){if(idx<0){for(i=0;i<SM.show.seats.length;i++){$('#s'+SM.show.seats[i].id).attr('src','images/'+SM.show.inactive);}
setTimeout('SM.animation('+(idx+1)+')',250);}else{if(idx<SM.show.seats.length){$('#s'+SM.show.seats[idx].id).attr('src','images/'+SM.show.blocked);setTimeout('SM.animation('+(idx+1)+')',125);}}},description_1:function(str){idx=str.indexOf('-');if(idx>0){return $.trim(str.substr(0,idx));}
return str;}};